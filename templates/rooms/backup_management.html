{% extends 'base.html' %}

{% block title %}Backup Management - Hotel Snow PMS{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">üìÅ Backup Management</h2>
            
            <!-- Backup Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">{{ total_backups }}</h5>
                            <p class="card-text">Total Backups</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success">{{ auto_backups }}</h5>
                            <p class="card-text">Auto Backups</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-primary">{{ manual_backups }}</h5>
                            <p class="card-text">Manual Backups</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-info">Every 10 min</h5>
                            <p class="card-text">Auto Schedule</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="btn-group" role="group">
                        <a href="{% url 'export_data' %}" class="btn btn-success">
                            <i class="fas fa-download"></i> Export Current Data
                        </a>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importModal">
                            <i class="fas fa-upload"></i> Import Data
                        </button>
                        <a href="{% url 'manual_backup' %}" class="btn btn-info">
                            <i class="fas fa-save"></i> Create Manual Backup
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Backup List -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Backup History</h5>
                </div>
                <div class="card-body">
                    {% if backups %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>File Name</th>
                                    <th>Created</th>
                                    <th>Created By</th>
                                    <th>Bookings</th>
                                    <th>Size (KB)</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for backup in backups %}
                                <tr>
                                    <td>
                                        {% if backup.backup_type == 'AUTO' %}
                                            <span class="badge bg-success">Auto</span>
                                        {% elif backup.backup_type == 'MANUAL' %}
                                            <span class="badge bg-primary">Manual</span>
                                        {% else %}
                                            <span class="badge bg-info">Import</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ backup.file_name }}</td>
                                    <td>{{ backup.created_at|date:"M d, Y H:i" }}</td>
                                    <td>{{ backup.created_by.username|default:"System" }}</td>
                                    <td>{{ backup.booking_count }}</td>
                                    <td>{{ backup.get_file_size|floatformat:1 }}</td>
                                    <td>{{ backup.notes|truncatechars:50 }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'download_backup' backup.id %}" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            {% if backup.backup_type != 'AUTO' %}
                                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                                    onclick="confirmDelete({{ backup.id }}, '{{ backup.file_name }}')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if backups.has_other_pages %}
                    <nav aria-label="Backup pagination">
                        <ul class="pagination justify-content-center">
                            {% if backups.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1">&laquo; First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ backups.previous_page_number }}">Previous</a>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">
                                    Page {{ backups.number }} of {{ backups.paginator.num_pages }}
                                </span>
                            </li>
                            
                            {% if backups.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ backups.next_page_number }}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ backups.paginator.num_pages }}">Last &raquo;</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">No backups found. The automatic backup system will create backups every 10 minutes.</p>
                        <a href="{% url 'manual_backup' %}" class="btn btn-primary">Create First Manual Backup</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'import_data' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="importModalLabel">Import Data from Excel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="excel_file" class="form-label">Select Excel File</label>
                        <input type="file" class="form-control" id="excel_file" name="excel_file" accept=".xlsx,.xls" required>
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <strong>Note:</strong> The Excel file should contain 'Bookings' sheet with the correct column headers.
                            You can download a current backup to see the expected format.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import Data</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete backup <strong id="deleteFileName"></strong>?</p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" id="deleteForm" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDelete(backupId, fileName) {
    document.getElementById('deleteFileName').textContent = fileName;
    document.getElementById('deleteForm').action = `/delete-backup/${backupId}/`;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
</script>
{% endblock %}